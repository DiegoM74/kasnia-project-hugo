/* ====== VARIABLES GLOBALES ====== */
:root {
  --reader-bg: #1a1a1a;
  --reader-text: #e0e0e0;
  --reader-font: system-ui, -apple-system, sans-serif;
  --reader-size: 18px;
  --reader-line-height: 1.6;

  --reader-ui-bg: rgba(20, 20, 20, 0.95);
  --reader-ui-border: #333;
  --reader-ui-text: #fff;
  
  --reader-accent: #3498db;
  --reader-toast-bg: #222;
  --reader-toast-text: #eee;
}

/* Temas */
[data-theme="light"] {
  --reader-bg: #ffffff;
  --reader-text: #222222;
  --reader-ui-bg: rgba(250, 250, 250, 0.95);
  --reader-ui-border: #ddd;
  --reader-ui-text: #111;
  --reader-toast-bg: #fff;
  --reader-toast-text: #111;
}

[data-theme="sepia"] {
  --reader-bg: #f4ecd8;
  --reader-text: #5b4636;
  --reader-ui-bg: rgba(240, 230, 210, 0.97);
  --reader-ui-border: #d5c8a4;
  --reader-ui-text: #4a382b;
  --reader-toast-bg: #fdf6e3;
  --reader-toast-text: #5b4636;
}

[data-theme="oled"] {
  --reader-bg: #000000;
  --reader-text: #dcdcdc;
  --reader-ui-bg: rgba(0, 0, 0, 0.98);
  --reader-ui-border: #222;
  --reader-ui-text: #fff;
  --reader-toast-bg: #111;
  --reader-toast-text: #fff;
}

/* ====== RESET Y CONTENEDOR ====== */
html, body.webReaderBody {
  margin: 0;
  padding: 0;
  width: 100%;
  min-height: 100vh;
  background-color: var(--reader-bg);
  color: var(--reader-text);
  font-family: var(--reader-font);
  font-size: var(--reader-size);
  line-height: var(--reader-line-height);
  overflow-x: hidden;
  transition: background-color 0.3s ease, color 0.3s ease;
}

body.webReaderBody.pagedMode {
  overflow: hidden; /* Evitar scroll vertical nativo en modo libro */
  height: 100vh;
  height: 100dvh;
  /* Compensar el área segura del navegador (menús del navegador en móvil) */
  padding-top: env(safe-area-inset-top, 0px);
  padding-bottom: env(safe-area-inset-bottom, 0px);
}

.webReaderContainer {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  position: relative;
}

/* En modo paginado, el body ya tiene overflow:hidden y height fija.
   El contenedor no debe forzar una altura mínima que cause overflow vertical. */
body.pagedMode .webReaderContainer {
  min-height: 0;
  height: 100%;
  overflow: hidden;
}

/* ====== COMPONENTES UI (HEADER / FOOTER) ====== */
.webReaderHeader, .webReaderFooter {
  position: fixed;
  left: 0;
  right: 0;
  background: var(--reader-ui-bg);
  color: var(--reader-ui-text);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: transform 0.3s ease, opacity 0.3s ease;
  z-index: 50;
  border: 1px solid var(--reader-ui-border);
}

.webReaderHeader {
  top: 0;
  border-top: none;
  border-left: none;
  border-right: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
}

.webReaderFooter {
  bottom: 0;
  border-bottom: none;
  border-left: none;
  border-right: none;
  padding: 0.8rem 1rem;
  text-align: center;
}

.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateY(-100%);
}

.webReaderFooter.hidden {
  transform: translateY(100%);
}

.readerTitleContainer {
  text-align: center;
  flex-grow: 1;
  overflow: hidden;
}

.readerNovelTitle {
  font-size: 0.95rem;
  font-weight: 600;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  letter-spacing: 0.5px;
  font-family: var(--reader-font);
  opacity: 0.9;
}

.readerChapterTitle {
  font-size: 0.8rem;
  opacity: 0.8;
  margin: 0;
  font-weight: normal;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.readerBtn {
  background: transparent;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 5px;
}

.readerBtn:hover {
  background: rgba(128, 128, 128, 0.2);
}

/* ====== ÁREA DE LECTURA (CONTENT) ====== */
.webReaderContent {
  flex-grow: 1;
  padding: 40px 20px;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  box-sizing: border-box;
  padding-top: 80px;
  padding-bottom: 80px;
}

/* Clases utilitarias solicitadas por el usuario */
.webReaderContent[data-hyphens="true"] p {
  hyphens: auto;
  -webkit-hyphens: auto;
}

.webReaderContent p {
  text-indent: 1.5rem;
  margin-top: 1rem;
  margin-right: 0;
  margin-bottom: 1rem;
  margin-left: 0;
  text-align: justify;
}

.webReaderContent p.noidentar {
  text-indent: 0 !important;
}

.webReaderContent p.salto0 {
  margin-top: 0.5rem;
}

.webReaderContent p.salto1 {
  margin-top: 1.5rem;
}

.webReaderContent p.salto2 {
  margin-top: 2rem;
}

.webReaderContent p.salto3 {
  margin-top: 3rem;
}

.webReaderContent p.centrado {
  text-align: center !important;
  text-indent: 0 !important;
}

.webReaderContent p.grande {
  font-size: 1.16rem;
}

.webReaderContent .versalita {
  font-size: 0.83rem;
}

.webReaderContent b, .webReaderContent strong {
  font-weight: bold;
}

.webReaderContent i, .webReaderContent em {
  font-style: italic;
}

.webReaderContent figure {
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
  margin-right: auto;
  margin-left: auto;
  line-height: 0;
  text-align: center;
  object-fit: contain;
}

.webReaderContent img {
  width: auto;
  max-width: 100%;
  height: auto;
  max-height: 95%;
  margin-top: 0;
  margin-right: auto;
  margin-bottom: 0;
  margin-left: auto;
  page-break-inside: avoid;
  break-inside: avoid;
  object-fit: contain;
  vertical-align: bottom;
}

.webReaderContent figure.hr img {
  width: auto;
  height: 1.15rem;
}

.readerLoadingSpinner {
  text-align: center;
  opacity: 0.7;
  padding: 2rem;
  font-style: italic;
}

.readerLoadPrevBtn {
  width: 100%;
  padding: 1rem;
  margin-bottom: 2rem;
  background: rgba(128, 128, 128, 0.1);
  border: 1px dashed var(--reader-ui-border);
  border-radius: 8px;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 1px;
}

.readerLoadPrevBtn:hover {
  background: rgba(128, 128, 128, 0.2);
}

/* ====== BARRA LATERAL (AJUSTES) ====== */
.webReaderSettings {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  z-index: 100;
  display: flex;
  justify-content: flex-end;
  visibility: visible;
  transition: visibility 0s linear 0s;
}

.webReaderSettings.hidden {
  visibility: hidden;
  pointer-events: none;
  opacity: 1;
  transform: none;
  transition: visibility 0s linear 0.3s;
}

.settingsOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  opacity: 1;
  transition: opacity 0.3s ease;
}

.webReaderSettings.hidden .settingsOverlay {
  opacity: 0;
}

.settingsPanel {
  position: relative;
  width: 320px;
  max-width: 80%;
  height: 100%;
  background: var(--reader-ui-bg);
  border-left: 1px solid var(--reader-ui-border);
  color: var(--reader-ui-text);
  padding: 20px;
  box-sizing: border-box;
  transform: translateX(0);
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.webReaderSettings.hidden .settingsPanel {
  transform: translateX(100%);
}

.settingsPanel h3 {
  margin: 0;
}

.panelHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--reader-ui-border);
  padding-bottom: 15px;
  margin-bottom: 20px;
}

.btnClosePanel {
  background: transparent;
  border: none;
  color: inherit;
  font-size: 1.8rem;
  line-height: 1;
  cursor: pointer;
  padding: 0 5px;
  opacity: 0.7;
}

.btnClosePanel:hover {
  opacity: 1;
}

.settingGroup {
  margin-bottom: 25px;
}

.settingGroup label {
  display: block;
  font-size: 0.9rem;
  opacity: 0.8;
  margin-bottom: 10px;
}

.toggleControl {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.toggleControl label {
  margin-bottom: 0;
}

.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(128, 128, 128, 0.3);
  transition: .3s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: var(--reader-ui-text);
  transition: .3s;
}

input:checked + .slider {
  background-color: var(--reader-accent);
}

input:checked + .slider:before {
  transform: translateX(20px);
  background-color: #fff;
}

.slider.round {
  border-radius: 24px;
}

.slider.round:before {
  border-radius: 50%;
}

.themeOptions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.themeBtn {
  border: none;
  border-radius: 6px;
  padding: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.9rem;
}

.rangeControl {
  display: flex;
  align-items: center;
  gap: 15px;
}

.rangeControl input[type="range"] {
  flex-grow: 1;
}

.readerSelect {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  background: transparent;
  color: inherit;
  border: 1px solid var(--reader-ui-border);
  font-family: inherit;
}
.readerSelect option {
  background: var(--reader-ui-bg);
  color: var(--reader-ui-text);
}

/* ====== TOAST (FOOTNOTES) ====== */
.footnoteToast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(0);
  width: 90%;
  max-width: 500px;
  background: var(--reader-toast-bg);
  color: var(--reader-toast-text);
  border: 1px solid var(--reader-ui-border);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  z-index: 200;
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
  padding: 15px;
  box-sizing: border-box;
}

.footnoteToast.hidden {
  opacity: 0;
  transform: translateX(-50%) translateY(150px);
  pointer-events: none;
}

.toastHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(128,128,128,0.2);
  padding-bottom: 10px;
  margin-bottom: 10px;
  font-size: 0.85rem;
  font-weight: bold;
  text-transform: uppercase;
  opacity: 0.8;
}

.toastHeader button {
  background: none;
  border: none;
  color: inherit;
  font-size: 1.5rem;
  line-height: 1;
  cursor: pointer;
  padding: 0 5px;
}

.toastContent {
  font-size: 0.95rem;
  line-height: 1.5;
  text-align: left;
}
.toastContent p {
  margin: 0;
  text-indent: 0;
}

/* ====== TOC ====== */
.readerTocList {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.tocBtn {
  width: 100%;
  text-align: left;
  background: transparent;
  border: 1px solid var(--reader-ui-border);
  border-left: 4px solid transparent;
  color: inherit;
  padding: 12px 15px;
  border-radius: 6px;
  font-family: inherit;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.tocBtn:hover {
  background: rgba(128, 128, 128, 0.1);
  border-color: var(--reader-ui-border);
}

.tocBtn.active {
  border-left-color: var(--reader-accent);
  background: rgba(128, 128, 128, 0.15);
  font-weight: bold;
}

.readerChunk {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
}

/* Estilos texto */
.readerChunk h1, .readerChunk h2, .readerChunk h3, .readerChunk h4, .readerChunk h5, .readerChunk h6 {
  font-size: 1.16666666rem;
  font-weight: bold;
  text-align: center;
}

.readerChunk h1 {
  font-size: 1.5rem;
  line-height: 1;
  margin-top: 2.5rem;
  margin-bottom: 2rem;
}

.readerChunk h2 {
  font-size: 1.3750rem;
  line-height: 1.09090909;
  margin-top: 2.18181818rem;
  margin-bottom: 1.09090909rem;
}

.readerChunk h3 {
  font-size: 1.25rem;
  line-height: 1.2;
  margin-top: 1.2rem;
  margin-bottom: 1.2rem;
}

.readerChunk h4 {
  font-size: 1.125rem;
  line-height: 1.33333333;
  margin-top: 1.33333333rem;
  margin-bottom: 0rem;
}

.readerChunk h1.titulo {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 1.5rem;
  margin-bottom: 0;
}

.readerChunk h2.subtitulo {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.5rem;
  margin-bottom: 0;
}

.readerChunk .centrado {
  text-indent: 0;
  text-align: center;
}

.readerChunk a {
  color: var(--reader-accent);
  text-decoration: none;
}

.readerChunk a:hover {
  text-decoration: underline;
}

/* ====== MODO PAGINADO ====== */

/*
  Estrategia del modo paginado:
  ─────────────────────────────
  Se usa CSS Multi-column layout: el contenedor tiene overflow-x:auto + overflow-y:hidden.
  column-width = ancho de la pantalla menos el padding horizontal → cada "columna" es una página.
  column-gap = 40px (los 40px entre columnas quedan fuera del viewport, actuando como separador).
  column-fill: auto → rellena columna a columna sin balancear.
  El usuario avanza con scroll horizontal (o click en los bordes de pantalla).

  Problema de los menús del navegador (Brave, Chrome en móvil):
  ─────────────────────────────────────────────────────────────
  dvh  = dynamic viewport height → cambia según si los menús están visibles o no.
  svh  = small viewport height   → altura cuando los menús ESTÁN visibles (el mínimo).
  lvh  = large viewport height   → altura cuando los menús están ocultos (el máximo).

  Usando 100svh aseguramos que el contenido NUNCA quede tapado por los menús del nav,
  porque siempre calculamos con la altura más pequeña (la más conservadora).

  El header y footer del lector son position:fixed y flotan encima del contenido.
  Con margin-top/bottom igualamos su altura para que el texto no quede detrás de ellos.
  --reader-header-h y --reader-footer-h se calculan en JS con offsetHeight real.
*/

.webReaderContent.pagedMode {
  /* Altura del área de lectura: svh total menos las barras del lector */
  height: calc(100svh - var(--reader-header-h, 60px) - var(--reader-footer-h, 60px));
  min-height: auto;
  max-width: none;

  /*
    margin-top reserva el espacio del header del lector.
    Aunque el header esté oculto (opacity:0 + translateY), como es position:fixed
    no afecta el flujo del documento. El margin-top aquí define desde dónde
    empieza el área de lectura en el viewport — siempre bajo el header del lector.
    Esto también sirve de buffer contra los menús del navegador en dispositivos móviles.
  */
  margin-top: var(--reader-header-h, 60px);
  margin-bottom: 0;
  margin-left: 0;
  margin-right: 0;

  /* Padding interno: espacio entre el borde de la "página" y el texto */
  padding-top: 12px;
  padding-bottom: 12px;
  padding-left: 20px;
  padding-right: 20px;

  /* Lógica de columnas (= páginas) */
  column-width: calc(100vw - 40px); /* Una columna = viewport - padding L+R (20+20) */
  column-gap: 40px;                  /* Gap entre cols → queda oculto fuera del viewport */
  column-fill: auto;                 /* Sin balanceo: rellena col por col */

  /* Scroll horizontal entre páginas, sin scroll vertical */
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  box-sizing: border-box;
}

/* Control estricto de Párrafos: Viudas y Huérfanas */
.webReaderContent.pagedMode p {
  orphans: 2;
  widows: 2;
}

/*
  SECCIONES: cada readerChunk empieza en su propia página (columna).

  Selector: .readerChunk ~ .readerChunk
  Significa: un readerChunk que esté precedido por OTRO readerChunk como hermano.
  Esto es correcto porque dentro del contenedor hay un elemento topBoundary (div)
  ANTES del primer readerChunk. Si usáramos :not(:first-child), el primer chunk
  también recibiría break-before (porque no es el primer HIJO, sí el primer chunk),
  generando una página vacía al principio.
  Con ~ solo aplicamos break-before a chunks que vienen DESPUÉS de otro chunk.
*/
.webReaderContent.pagedMode .readerChunk ~ .readerChunk {
  break-before: column;
  page-break-before: always;
}

/*
  IMÁGENES SOLAS EN PÁGINA:
  Las figures que son ilustraciones reales (portadas, ilustraciones internas) se muestran solas.
  Excluimos figure.hr (separadores decorativos pequeños) que deben fluir con el texto.
  - break-before/after: su "página" está aislada (nada antes ni después)
  - height: var(--reader-content-h) → ocupa exactamente el alto de una página
    (la variable la calcula JS con visualViewport.height - header - footer)
  - display:flex + align/justify center → centra la imagen dentro de esa página
*/
.webReaderContent.pagedMode figure:not(.hr) {
  break-before: column;
  break-after: column;
  page-break-before: always;
  page-break-after: always;
  break-inside: avoid;
  page-break-inside: avoid;
  display: flex;
  align-items: center;
  justify-content: center;
  /* Altura = toda la página disponible para el contenido */
  height: var(--reader-content-h, 80dvh);
  min-height: var(--reader-content-h, 80dvh);
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Prevenir que títulos y bloques internos se partan entre páginas */
.webReaderContent.pagedMode h1,
.webReaderContent.pagedMode h2,
.webReaderContent.pagedMode h3,
.webReaderContent.pagedMode h4,
.webReaderContent.pagedMode h5,
.webReaderContent.pagedMode .readerChunk > div {
  break-inside: avoid;
  page-break-inside: avoid;
}

/*
  IMÁGENES: se ajustan al alto de la página disponible.
  --reader-content-h lo calcula JS en px exactos (= viewH - headerH - footerH).
  El padding interno es 12px arriba + 12px abajo = 24px.
*/
.webReaderContent.pagedMode img {
  max-height: calc(var(--reader-content-h, 80dvh) - 24px);
  max-width: 100%;
  width: auto;
  height: auto;
  display: block;
  margin: 0 auto;
  object-fit: contain;
}
