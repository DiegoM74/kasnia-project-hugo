document.addEventListener("DOMContentLoaded",()=>{const C=document.documentElement,K=document.getElementById("webReaderContainer"),w=document.getElementById("webReaderHeader"),A=document.getElementById("webReaderFooter"),I=document.getElementById("btnBack"),P=document.getElementById("btnSettings"),r=document.getElementById("webReaderSettings"),R=document.getElementById("settingsOverlay"),L=document.querySelectorAll(".themeBtn"),S=document.getElementById("fontSizeRange"),M=document.getElementById("lineHeightRange"),k=document.getElementById("fontFamilySelect"),p=document.getElementById("footnoteToast"),V=document.getElementById("footnoteToastContent"),N=document.getElementById("btnCloseToast"),g=document.getElementById("btnToc"),d=document.getElementById("webReaderTocPanel"),v=document.getElementById("tocOverlay"),b=document.getElementById("hyphensToggle"),j=document.getElementById("btnCloseSettings"),y=document.getElementById("btnCloseToc");let f=!1;const $=()=>{const o=localStorage.getItem("kasniaReaderTheme")||"dark",e=localStorage.getItem("kasniaReaderFontSize")||"18",n=localStorage.getItem("kasniaReaderLineHeight")||"1.6",s=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif",i=localStorage.getItem("kasniaReaderHyphens")||"false";C.setAttribute("data-theme",o),document.documentElement.style.setProperty("--reader-size",`${e}px`),document.documentElement.style.setProperty("--reader-line-height",n),document.documentElement.style.setProperty("--reader-font",s),i==="true"&&(t.setAttribute("data-hyphens","true"),b.checked=!0),S.value=e,M.value=n,k.value=s},i=(e,t)=>{localStorage.setItem(e,t)};L.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");C.setAttribute("data-theme",t),i("kasniaReaderTheme",t)})}),S.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),i("kasniaReaderFontSize",t)}),M.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),i("kasniaReaderLineHeight",t)}),k.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),i("kasniaReaderFont",t)}),b.addEventListener("change",e=>{const n=e.target.checked;n?(t.setAttribute("data-hyphens","true"),i("kasniaReaderHyphens","true")):(t.removeAttribute("data-hyphens"),i("kasniaReaderHyphens","false"))});const x=()=>{f=!f,f?(w.classList.remove("hidden"),A.classList.remove("hidden")):(w.classList.add("hidden"),A.classList.add("hidden"),r.classList.add("hidden"),d.classList.add("hidden"))};K.addEventListener("click",e=>{if(e.target.closest("button")||e.target.closest("a")||e.target.closest(".webReaderHeader")||e.target.closest(".webReaderSettings")||e.target.closest(".footnoteToast"))return;x()}),P.addEventListener("click",()=>{r.classList.remove("hidden"),d.classList.add("hidden")}),R.addEventListener("click",()=>{r.classList.add("hidden")}),g&&g.addEventListener("click",()=>{d.classList.remove("hidden"),r.classList.add("hidden")}),v&&v.addEventListener("click",()=>{d.classList.add("hidden")}),j&&j.addEventListener("click",()=>{r.classList.add("hidden")}),y&&y.addEventListener("click",()=>{d.classList.add("hidden")}),I.addEventListener("click",()=>{window.history.back()});const h=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(V.innerHTML=s.innerHTML,p.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};N.addEventListener("click",()=>{p.classList.add("hidden")});const E=()=>{const s=document.querySelectorAll(".readerChunk[data-chapter-index]");let e=-1,t=1/0;const n=window.innerHeight||document.documentElement.clientHeight;s.forEach(s=>{const o=s.getBoundingClientRect();o.top<=n/3&&o.bottom>=n/3?e=parseInt(s.getAttribute("data-chapter-index")):o.top>=0&&o.top<t&&(t=o.top,e===-1&&(e=parseInt(s.getAttribute("data-chapter-index"))))}),e!==-1&&document.querySelectorAll(".tocBtn").forEach((t,n)=>{n===e?t.classList.add("active"):t.classList.remove("active")})};window.addEventListener("scroll",()=>{typeof u=="function"&&u(),E()},{passive:!0});const t=document.getElementById("webReaderContent"),z=document.getElementById("readerNovelTitle");let q=[],Y=0;const F=new URLSearchParams(window.location.search),T=F.get("novel")||"seirei-gensouki",B=F.get("vol")||"25",s=`/lector/data/${T}-${B}/`;let o=[],c=0,n=0,e=!1,H=null;const l=document.createElement("div"),a=document.createElement("div");l.style.height="1px",a.style.height="100px";const O=(e,t="")=>{let n=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(n+=`<source srcset="${s}${e}" type="image/avif">`),e.endsWith(".webp")&&(n+=`<source srcset="${s}${e}" type="image/webp">`)});const o=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];n+=`<img src="${s}${o}" alt="${t}">`}else n+=`<img src="${e}" alt="${t}">`;return n+=`</picture>`,n},m=async e=>{if(e<0||e>=o.length)return[];const t=o[e];let n=[];try{if(t.type==="cover"||t.type==="image"){let s=document.createElement("figure");return s.className="dimg grande readerChunk",s.setAttribute("data-chapter-index",e),s.innerHTML=O(t.images,t.title),n.push(s),n}if(t.type==="gallery")return t.images.forEach(s=>{let o=document.createElement("figure");o.className="dimg grande readerChunk",o.setAttribute("data-chapter-index",e),o.innerHTML=O(s,t.title),n.push(o)}),n;if(t.type==="html"){const a=await fetch(`${s}${t.file}`);if(!a.ok)throw new Error("Fragmento HTML fallido");const c=await a.text(),l=new DOMParser,r=l.parseFromString(c,"text/html"),d=r.querySelectorAll("img");d.forEach(e=>{let t=e.getAttribute("src");if(t&&t.includes("../Images/")){t=t.replace("../Images/","");let o=t.replace(".jpg","").replace(".jpeg","").replace(".png",""),n=document.createElement("picture");n.innerHTML=`<source srcset="${s}${o}.avif" type="image/avif"><img src="${s}${t}" alt="IlustraciÃ³n">`,e.parentNode.replaceChild(n,e)}});let o=r.body.children;o.length===1&&o[0].tagName==="SECTION"&&(o=o[0].children);let i=document.createElement("div");return i.className="readerChunk",i.setAttribute("data-chapter-index",e),Array.from(o).forEach(e=>{i.appendChild(e.cloneNode(!0))}),n.push(i),n}}catch(e){console.warn("Fallo cargando seccion:",e)}return n},W=async()=>{if(e||c<=0)return;e=!0,c--;const t=await m(c);if(t.length>0){const n=[];t.forEach(e=>{e.nodeType===1&&n.push(...Array.from(e.querySelectorAll("img")))}),n.length>0&&await Promise.all(n.map(e=>e.complete?Promise.resolve():new Promise(t=>{e.onload=t,e.onerror=t})));const e=l.nextElementSibling;let s=e?e.getBoundingClientRect().top:0;if(t.reverse().forEach(e=>l.insertAdjacentElement("afterend",e)),e){const t=e.getBoundingClientRect().top-s;window.scrollBy(0,t)}}h(),e=!1,setTimeout(u,150)},U=async()=>{if(e||n>=o.length-1)return;e=!0,n++;const t=await m(n);if(t.forEach(e=>a.insertAdjacentElement("beforebegin",e)),h(),n>=o.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",a.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}e=!1,setTimeout(u,150)},u=()=>{if(e)return;const t=l.getBoundingClientRect(),s=a.getBoundingClientRect(),i=window.innerHeight||document.documentElement.clientHeight;t.bottom>=-300&&c>0?W():s.top<=i+300&&n<o.length-1&&U()},_=async s=>{e=!0,t.innerHTML="",c=s,n=s;const i=await m(s);if(t.appendChild(l),i.forEach(e=>t.appendChild(e)),n>=o.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",t.appendChild(e),document.querySelector(".readerLoadingSpinner")?.remove()}t.appendChild(a),e=!1,h(),window.scrollTo(0,0),setTimeout(()=>{u(),E()},200)},D=async()=>{try{const t=await fetch(`${s}index.json`);if(!t.ok)throw new Error("Index.json no encontrado");const e=await t.json();H=e,document.title=`${e.title} Vol ${e.volume} - Lector Web`,z.textContent=`${e.title} - Volumen ${e.volume}`,o=e.order;const n=document.getElementById("readerTocList");return n&&e.order.forEach((e,t)=>{let o=document.createElement("li"),s=document.createElement("button");s.className="tocBtn",s.textContent=e.title,s.onclick=()=>{_(t),x()},o.appendChild(s),n.appendChild(o)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};$(),h(),D().then(e=>{if(e)_(0);else{const e=document.querySelector(".readerLoadingSpinner");e&&(e.textContent="Error: Faltan archivos de datos (index.json)")}})})