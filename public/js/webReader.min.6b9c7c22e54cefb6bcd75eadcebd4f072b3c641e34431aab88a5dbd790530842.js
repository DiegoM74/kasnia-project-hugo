document.addEventListener("DOMContentLoaded",()=>{const x=document.documentElement,Y=document.getElementById("webReaderContainer"),v=document.getElementById("webReaderHeader"),g=document.getElementById("webReaderFooter"),L=document.getElementById("btnBack"),H=document.getElementById("btnSettings"),d=document.getElementById("webReaderSettings"),P=document.getElementById("settingsOverlay"),e=document.getElementById("webReaderContent"),$=document.getElementById("readerNovelTitle"),V=document.querySelectorAll(".themeBtn"),O=document.getElementById("fontSizeRange"),k=document.getElementById("lineHeightRange"),C=document.getElementById("fontFamilySelect"),A=document.getElementById("footnoteToast"),K=document.getElementById("footnoteToastContent"),I=document.getElementById("btnCloseToast"),N=document.getElementById("btnToc"),u=document.getElementById("webReaderTocPanel"),M=document.getElementById("tocOverlay"),y=document.getElementById("hyphensToggle"),f=document.getElementById("pagedModeToggle"),E=document.getElementById("btnCloseSettings"),S=document.getElementById("btnCloseToc");let p=!1;const s=()=>{const a=e.classList.contains("pagedMode");if(!a){e.style.height="",e.style.marginTop="",e.style.paddingBottom="",document.documentElement.style.removeProperty("--reader-header-h"),document.documentElement.style.removeProperty("--reader-footer-h"),document.documentElement.style.removeProperty("--reader-content-h");return}const n=window.visualViewport,r=n?n.height:window.innerHeight,s=20,t=v.offsetHeight||60,o=g.offsetHeight||60;document.documentElement.style.setProperty("--reader-header-h",`${t}px`),document.documentElement.style.setProperty("--reader-footer-h",`${o}px`);const i=r-t-o-s;e.style.height=`${i}px`,e.style.marginTop=`${t}px`,e.style.paddingBottom=`${s}px`,document.documentElement.style.setProperty("--reader-content-h",`${i}px`)};window.visualViewport&&(window.visualViewport.addEventListener("resize",s,{passive:!0}),window.visualViewport.addEventListener("scroll",s,{passive:!0})),window.addEventListener("resize",s,{passive:!0}),window.addEventListener("orientationchange",()=>{setTimeout(s,300)},{passive:!0});const q=()=>{const o=localStorage.getItem("kasniaReaderTheme")||"dark",t=localStorage.getItem("kasniaReaderFontSize")||"18",n=localStorage.getItem("kasniaReaderLineHeight")||"1.6",s=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif",i=localStorage.getItem("kasniaReaderHyphens")||"false",a=localStorage.getItem("kasniaReaderPagedMode")||"false";x.setAttribute("data-theme",o),document.documentElement.style.setProperty("--reader-size",`${t}px`),document.documentElement.style.setProperty("--reader-line-height",n),document.documentElement.style.setProperty("--reader-font",s),i==="true"&&(e.setAttribute("data-hyphens","true"),y&&(y.checked=!0)),a==="true"&&(document.body.classList.add("pagedMode"),e.classList.add("pagedMode"),f&&(f.checked=!0)),O.value=t,k.value=n,C.value=s},o=(e,t)=>{localStorage.setItem(e,t)};V.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");x.setAttribute("data-theme",t),o("kasniaReaderTheme",t)})}),O.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),o("kasniaReaderFontSize",t)}),k.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),o("kasniaReaderLineHeight",t)}),C.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),o("kasniaReaderFont",t)}),y.addEventListener("change",t=>{const n=t.target.checked;n?(e.setAttribute("data-hyphens","true"),o("kasniaReaderHyphens","true")):(e.removeAttribute("data-hyphens"),o("kasniaReaderHyphens","false"))}),f&&f.addEventListener("change",t=>{const n=t.target.checked;n?(document.body.classList.add("pagedMode"),e.classList.add("pagedMode"),o("kasniaReaderPagedMode","true")):(document.body.classList.remove("pagedMode"),e.classList.remove("pagedMode"),o("kasniaReaderPagedMode","false")),setTimeout(s,50)});const _=()=>{p=!p,p?(v.classList.remove("hidden"),g.classList.remove("hidden")):(v.classList.add("hidden"),g.classList.add("hidden"),d.classList.add("hidden"),u.classList.add("hidden")),setTimeout(s,350)};Y.addEventListener("click",t=>{if(t.target.closest("button")||t.target.closest("a")||t.target.closest(".webReaderHeader")||t.target.closest(".webReaderSettings")||t.target.closest(".footnoteToast"))return;if(e.classList.contains("pagedMode")){const s=t.clientX,n=window.innerWidth;s<n*.25?e.scrollBy({left:-n,behavior:"smooth"}):s>n*.75?e.scrollBy({left:n,behavior:"smooth"}):_()}else _()}),H.addEventListener("click",()=>{d.classList.remove("hidden"),u.classList.add("hidden")}),P.addEventListener("click",()=>{d.classList.add("hidden")}),N&&N.addEventListener("click",()=>{u.classList.remove("hidden"),d.classList.add("hidden")}),M&&M.addEventListener("click",()=>{u.classList.add("hidden")}),E&&E.addEventListener("click",()=>{d.classList.add("hidden")}),S&&S.addEventListener("click",()=>{u.classList.add("hidden")}),L.addEventListener("click",()=>{window.history.back()});const m=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(K.innerHTML=s.innerHTML,A.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};I.addEventListener("click",()=>{A.classList.add("hidden")});const j=()=>{const i=document.querySelectorAll(".readerChunk[data-chapter-index]"),a=e.classList.contains("pagedMode");let t=-1,n=1/0;const s=window.innerHeight||document.documentElement.clientHeight,o=window.innerWidth||document.documentElement.clientWidth;i.forEach(e=>{const i=e.getBoundingClientRect();a?i.left<=o/2&&i.right>=o/2?t=parseInt(e.getAttribute("data-chapter-index")):i.left>=0&&i.left<n&&(n=i.left,t===-1&&(t=parseInt(e.getAttribute("data-chapter-index")))):i.top<=s/3&&i.bottom>=s/3?t=parseInt(e.getAttribute("data-chapter-index")):i.top>=0&&i.top<n&&(n=i.top,t===-1&&(t=parseInt(e.getAttribute("data-chapter-index"))))}),t!==-1&&document.querySelectorAll(".tocBtn").forEach((e,n)=>{n===t?e.classList.add("active"):e.classList.remove("active")})};window.addEventListener("scroll",()=>{typeof a=="function"&&a(),j()},{passive:!0}),e.addEventListener("scroll",()=>{e.classList.contains("pagedMode")&&(typeof a=="function"&&a(),j())},{passive:!0});let G=[],X=0;const z=new URLSearchParams(window.location.search),W=z.get("novel")||"seirei-gensouki",R=z.get("vol")||"25",r=`/lector/data/${W}-${R}/`;let n=[],c=0,i=0,t=!1,B=null;const l=document.createElement("div"),h=document.createElement("div");l.style.height="1px",h.style.height="100px";const D=(e,t="")=>{let n=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(n+=`<source srcset="${r}${e}" type="image/avif">`),e.endsWith(".webp")&&(n+=`<source srcset="${r}${e}" type="image/webp">`)});const s=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];n+=`<img src="${r}${s}" alt="${t}">`}else n+=`<img src="${e}" alt="${t}">`;return n+=`</picture>`,n},b=async e=>{if(e<0||e>=n.length)return[];const t=n[e];let s=[];try{if(t.type==="cover"||t.type==="image"){let n=document.createElement("figure");return n.className="readerChunk",n.setAttribute("data-chapter-index",e),n.setAttribute("data-type","image-only"),n.innerHTML=D(t.images,t.title),s.push(n),s}if(t.type==="gallery")return t.images.forEach(n=>{let o=document.createElement("figure");o.className="dimg grande readerChunk",o.setAttribute("data-chapter-index",e),o.innerHTML=D(n,t.title),s.push(o)}),s;if(t.type==="html"){const i=await fetch(`${r}${t.file}`);if(!i.ok)throw new Error("Fragmento HTML fallido");const c=await i.text(),l=new DOMParser,a=l.parseFromString(c,"text/html"),d=a.querySelectorAll("img");d.forEach(e=>{let t=e.getAttribute("src");if(t&&t.includes("../Images/")){t=t.replace("../Images/","");let s=t.replace(".jpg","").replace(".jpeg","").replace(".png",""),n=document.createElement("picture");n.innerHTML=`<source srcset="${r}${s}.avif" type="image/avif"><img src="${r}${t}" alt="IlustraciÃ³n">`,e.parentNode.replaceChild(n,e)}});let n=a.body.children;n.length===1&&n[0].tagName==="SECTION"&&(n=n[0].children);let o=document.createElement("div");return o.className="readerChunk",o.setAttribute("data-chapter-index",e),Array.from(n).forEach(e=>{o.appendChild(e.cloneNode(!0))}),s.push(o),s}}catch(e){console.warn("Fallo cargando seccion:",e)}return s},F=async()=>{if(t||c<=0)return;t=!0,c--;const n=await b(c);if(n.length>0){const s=[];n.forEach(e=>{e.nodeType===1&&s.push(...Array.from(e.querySelectorAll("img")))}),s.length>0&&await Promise.all(s.map(e=>e.complete?Promise.resolve():new Promise(t=>{e.onload=t,e.onerror=t})));const o=e.classList.contains("pagedMode"),t=l.nextElementSibling;let i=t?t.getBoundingClientRect().top:0,a=t?t.getBoundingClientRect().left:0;if(n.reverse().forEach(e=>l.insertAdjacentElement("afterend",e)),t)if(o){const n=t.getBoundingClientRect().left-a;e.scrollBy({left:n,behavior:"instant"})}else{const e=t.getBoundingClientRect().top-i;window.scrollBy(0,e)}}m(),t=!1,setTimeout(a,150)},w=async()=>{if(t||i>=n.length-1)return;t=!0,i++;const e=await b(i);if(e.forEach(e=>h.insertAdjacentElement("beforebegin",e)),m(),i>=n.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",h.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}t=!1,setTimeout(a,150)},a=()=>{if(t)return;const s=e.classList.contains("pagedMode");if(s){const t=e.scrollLeft,s=e.scrollWidth,o=e.clientWidth;t<=300&&c>0?F():t+o>=s-300&&i<n.length-1&&w()}else{const e=l.getBoundingClientRect(),t=h.getBoundingClientRect(),s=window.innerHeight||document.documentElement.clientHeight;e.bottom>=-300&&c>0?F():t.top<=s+300&&i<n.length-1&&w()}},T=async o=>{t=!0,e.innerHTML="",c=o,i=o;const r=await b(o);if(e.appendChild(l),r.forEach(t=>e.appendChild(t)),i>=n.length-1){let t=document.createElement("p");t.className="centrado salto2",t.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",e.appendChild(t),document.querySelector(".readerLoadingSpinner")?.remove()}e.appendChild(h),t=!1,m(),window.scrollTo(0,0),setTimeout(()=>{s(),a(),j()},200)},U=async()=>{try{const t=await fetch(`${r}index.json`);if(!t.ok)throw new Error("Index.json no encontrado");const e=await t.json();B=e,document.title=`${e.title} Vol ${e.volume} - Lector Web`,$.textContent=`${e.title} - Volumen ${e.volume}`,n=e.order;const s=document.getElementById("readerTocList");return s&&e.order.forEach((e,t)=>{let o=document.createElement("li"),n=document.createElement("button");n.className="tocBtn",n.textContent=e.title,n.onclick=()=>{T(t),_()},o.appendChild(n),s.appendChild(o)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};q(),s(),m(),U().then(e=>{if(e)T(0);else{const e=document.querySelector(".readerLoadingSpinner");e&&(e.textContent="Error: Faltan archivos de datos (index.json)")}})})