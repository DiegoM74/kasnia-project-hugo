document.addEventListener("DOMContentLoaded",()=>{const y=document.documentElement,L=document.getElementById("webReaderContainer"),O=document.getElementById("webReaderHeader"),x=document.getElementById("webReaderFooter"),z=document.getElementById("btnBack"),k=document.getElementById("btnSettings"),h=document.getElementById("webReaderSettings"),S=document.getElementById("settingsOverlay"),T=document.querySelectorAll(".themeBtn"),C=document.getElementById("fontSizeRange"),w=document.getElementById("lineHeightRange"),b=document.getElementById("fontFamilySelect"),f=document.getElementById("footnoteToast"),D=document.getElementById("footnoteToastContent"),P=document.getElementById("btnCloseToast"),p=document.getElementById("progressText");let m=!1;const R=()=>{const s=localStorage.getItem("kasniaReaderTheme")||"dark",e=localStorage.getItem("kasniaReaderFontSize")||"18",t=localStorage.getItem("kasniaReaderLineHeight")||"1.6",n=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif";y.setAttribute("data-theme",s),document.documentElement.style.setProperty("--reader-size",`${e}px`),document.documentElement.style.setProperty("--reader-line-height",t),document.documentElement.style.setProperty("--reader-font",n),C.value=e,w.value=t,b.value=n},d=(e,t)=>{localStorage.setItem(e,t)};T.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");y.setAttribute("data-theme",t),d("kasniaReaderTheme",t)})}),C.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),d("kasniaReaderFontSize",t)}),w.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),d("kasniaReaderLineHeight",t)}),b.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),d("kasniaReaderFont",t)});const j=()=>{m=!m,m?(O.classList.remove("hidden"),x.classList.remove("hidden")):(O.classList.add("hidden"),x.classList.add("hidden"),h.classList.add("hidden"))};L.addEventListener("click",e=>{if(e.target.closest("button")||e.target.closest("a")||e.target.closest(".webReaderHeader")||e.target.closest(".webReaderSettings")||e.target.closest(".footnoteToast"))return;j()}),k.addEventListener("click",()=>{h.classList.remove("hidden")}),S.addEventListener("click",()=>{h.classList.add("hidden")}),z.addEventListener("click",()=>{window.history.back()});const r=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(D.innerHTML=s.innerHTML,f.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};P.addEventListener("click",()=>{f.classList.add("hidden")});const _=()=>{const t=window.scrollY||document.documentElement.scrollTop,n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),s=document.documentElement.clientHeight,e=n-s;if(e>0){const n=Math.min(100,Math.max(0,Math.round(t/e*100)));p.textContent=`${n}%`}else p.textContent=`100%`};window.addEventListener("scroll",_,{passive:!0});const l=document.getElementById("webReaderContent"),N=document.getElementById("readerNovelTitle");let V=[],B=0;const E=new URLSearchParams(window.location.search),M=E.get("novel")||"seirei-gensouki",F=E.get("vol")||"25",e=`/lector/data/${M}-${F}/`;let a=[],c=0,i=0,t=!1,s=null;const o=document.createElement("div"),n=document.createElement("div");o.style.height="1px",n.style.height="100px";const v=(t,n="")=>{let s=`<picture>`;if(Array.isArray(t)){t.forEach(t=>{t.endsWith(".avif")&&(s+=`<source srcset="${e}${t}" type="image/avif">`),t.endsWith(".webp")&&(s+=`<source srcset="${e}${t}" type="image/webp">`)});const o=t.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||t[0];s+=`<img src="${e}${o}" alt="${n}" loading="lazy">`}else s+=`<img src="${t}" alt="${n}" loading="lazy">`;return s+=`</picture>`,s},u=async t=>{if(t<0||t>=a.length)return[];const n=a[t];let o=[];try{if(n.id!=="cover"&&n.id!=="color_illus"&&n.id!=="title_page"){let e=document.createElement("div");e.className="readerSectionTitle";let t=document.createElement("h1");t.textContent=n.title,e.appendChild(t),o.push(e)}if(n.type==="cover"||n.type==="image"){let e=document.createElement("figure");return e.className="dimg grande readerChunk",e.innerHTML=v(n.images,n.title),o.push(e),o}if(n.type==="gallery")return n.images.forEach(e=>{let t=document.createElement("figure");t.className="dimg grande readerChunk",t.innerHTML=v(e,n.title),o.push(t)}),o;if(n.type==="synopsis"){let e=document.createElement("div");return e.className="readerChunk",e.innerHTML=`<h2 class="centrado" style="margin-bottom:2rem;">Sinopsis</h2><p>${s.synopsis}</p>`,o.push(e),o}if(n.type==="title"){let e=document.createElement("div");return e.className="readerChunk",e.innerHTML=`<div class="centrado salto2"><h1 style="font-size:3rem; margin-bottom:0;">${s.title}</h1><h2 style="opacity:0.8; margin-top:0;">Volumen ${s.volume}</h2><p class="salto2">Autor: ${s.author}<br>Ilustrador: ${s.illustrator}</p></div>`,o.push(e),o}if(n.type==="html"){const s=await fetch(`${e}${n.file}`);if(!s.ok)throw new Error("Fragmento HTML fallido");const a=await s.text(),r=new DOMParser,i=r.parseFromString(a,"text/html"),c=i.querySelectorAll("img");c.forEach(t=>{let n=t.getAttribute("src");if(n&&n.includes("../Images/")){n=n.replace("../Images/","");let o=n.replace(".jpg","").replace(".jpeg","").replace(".png",""),s=document.createElement("picture");s.innerHTML=`<source srcset="${e}${o}.avif" type="image/avif"><img src="${e}${n}" alt="IlustraciÃ³n" loading="lazy">`,t.parentNode.replaceChild(s,t)}});let t=i.body.children;return t.length===1&&t[0].tagName==="SECTION"&&(t=t[0].children),Array.from(t).forEach(e=>{let t=document.createElement("div");t.className="readerChunk",t.appendChild(e.cloneNode(!0)),o.push(t)}),o}}catch(e){console.warn("Fallo cargando seccion:",e)}return o},H=async e=>{l.innerHTML="",l.appendChild(o),c=e,i=e,t=!0;const s=await u(e);s.forEach(e=>l.appendChild(e)),l.appendChild(n),t=!1,r(),window.scrollTo(0,0)},I=async e=>{for(const s of e)if(s.isIntersecting&&!t){if(s.target===o&&c>0){t=!0,c--;const e=await u(c);if(e.length>0){const t=document.body.scrollHeight,n=window.scrollY||document.documentElement.scrollTop;e.reverse().forEach(e=>{o.insertAdjacentElement("afterend",e)});const s=document.body.scrollHeight;window.scrollTo(0,n+(s-t))}r(),t=!1}if(s.target===n&&i<a.length-1){t=!0,i++;const e=await u(i);if(e.forEach(e=>{n.insertAdjacentElement("beforebegin",e)}),r(),i>=a.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",n.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}t=!1}}},g=new IntersectionObserver(I,{rootMargin:"200px"});g.observe(o),g.observe(n);const A=async()=>{try{const n=await fetch(`${e}index.json`);if(!n.ok)throw new Error("Index.json no encontrado");const t=await n.json();s=t,document.title=`${t.title} Vol ${t.volume} - Lector Web`,N.textContent=`${t.title} - Volumen ${t.volume}`,a=t.order;const o=document.getElementById("readerTocList");return o&&t.order.forEach((e,t)=>{let s=document.createElement("li"),n=document.createElement("button");n.className="tocBtn",n.textContent=e.title,n.onclick=()=>{H(t),j()},s.appendChild(n),o.appendChild(s)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};R(),r(),_(),A().then(e=>{e?renderNextFragment():document.querySelector(".readerLoadingSpinner").textContent="Error: Faltan archivos de datos (index.json)"})})