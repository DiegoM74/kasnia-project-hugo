document.addEventListener("DOMContentLoaded",()=>{const x=document.documentElement,Y=document.getElementById("webReaderContainer"),f=document.getElementById("webReaderHeader"),m=document.getElementById("webReaderFooter"),R=document.getElementById("btnBack"),V=document.getElementById("btnSettings"),c=document.getElementById("webReaderSettings"),I=document.getElementById("settingsOverlay"),e=document.getElementById("webReaderContent"),H=document.getElementById("readerNovelTitle"),P=document.querySelectorAll(".themeBtn"),N=document.getElementById("fontSizeRange"),A=document.getElementById("lineHeightRange"),O=document.getElementById("fontFamilySelect"),k=document.getElementById("footnoteToast"),q=document.getElementById("footnoteToastContent"),U=document.getElementById("btnCloseToast"),D=document.getElementById("btnToc"),u=document.getElementById("webReaderTocPanel"),F=document.getElementById("tocOverlay"),y=document.getElementById("hyphensToggle"),g=document.getElementById("pagedModeToggle"),w=document.getElementById("btnCloseSettings"),S=document.getElementById("btnCloseToc");let v=!1;const h=()=>{const e=f.offsetHeight||60,t=m.offsetHeight||60;document.documentElement.style.setProperty("--reader-header-h",`${e}px`),document.documentElement.style.setProperty("--reader-footer-h",`${t}px`)};if(window.ResizeObserver){const e=new ResizeObserver(()=>h());e.observe(f),e.observe(m)}window.addEventListener("resize",h,{passive:!0});const K=()=>{const o=localStorage.getItem("kasniaReaderTheme")||"dark",t=localStorage.getItem("kasniaReaderFontSize")||"18",n=localStorage.getItem("kasniaReaderLineHeight")||"1.6",s=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif",i=localStorage.getItem("kasniaReaderHyphens")||"false",a=localStorage.getItem("kasniaReaderPagedMode")||"false";x.setAttribute("data-theme",o),document.documentElement.style.setProperty("--reader-size",`${t}px`),document.documentElement.style.setProperty("--reader-line-height",n),document.documentElement.style.setProperty("--reader-font",s),i==="true"&&(e.setAttribute("data-hyphens","true"),y&&(y.checked=!0)),a==="true"&&(document.body.classList.add("pagedMode"),e.classList.add("pagedMode"),g&&(g.checked=!0)),N.value=t,A.value=n,O.value=s},n=(e,t)=>{localStorage.setItem(e,t)};P.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");x.setAttribute("data-theme",t),n("kasniaReaderTheme",t)})}),N.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),n("kasniaReaderFontSize",t)}),A.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),n("kasniaReaderLineHeight",t)}),O.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),n("kasniaReaderFont",t)}),y.addEventListener("change",t=>{const s=t.target.checked;s?(e.setAttribute("data-hyphens","true"),n("kasniaReaderHyphens","true")):(e.removeAttribute("data-hyphens"),n("kasniaReaderHyphens","false"))}),g&&g.addEventListener("change",t=>{const s=t.target.checked;s?(document.body.classList.add("pagedMode"),e.classList.add("pagedMode"),n("kasniaReaderPagedMode","true")):(document.body.classList.remove("pagedMode"),e.classList.remove("pagedMode"),n("kasniaReaderPagedMode","false")),setTimeout(h,50)});const b=()=>{v=!v,v?(f.classList.remove("hidden"),m.classList.remove("hidden")):(f.classList.add("hidden"),m.classList.add("hidden"),c.classList.add("hidden"),u.classList.add("hidden")),setTimeout(h,350)};Y.addEventListener("click",t=>{if(t.target.closest("button")||t.target.closest("a")||t.target.closest(".webReaderHeader")||t.target.closest(".webReaderSettings")||t.target.closest(".footnoteToast"))return;if(e.classList.contains("pagedMode")){const s=t.clientX,n=window.innerWidth;s<n*.25?e.scrollBy({left:-n,behavior:"smooth"}):s>n*.75?e.scrollBy({left:n,behavior:"smooth"}):b()}else b()}),V.addEventListener("click",()=>{c.classList.remove("hidden"),u.classList.add("hidden")}),I.addEventListener("click",()=>{c.classList.add("hidden")}),D&&D.addEventListener("click",()=>{u.classList.remove("hidden"),c.classList.add("hidden")}),F&&F.addEventListener("click",()=>{u.classList.add("hidden")}),w&&w.addEventListener("click",()=>{c.classList.add("hidden")}),S&&S.addEventListener("click",()=>{u.classList.add("hidden")}),R.addEventListener("click",()=>{window.history.back()});const p=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(q.innerHTML=s.innerHTML,k.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};U.addEventListener("click",()=>{k.classList.add("hidden")});const _=()=>{const i=document.querySelectorAll(".readerChunk[data-chapter-index]"),a=e.classList.contains("pagedMode");let t=-1,n=1/0;const s=window.innerHeight||document.documentElement.clientHeight,o=window.innerWidth||document.documentElement.clientWidth;i.forEach(e=>{const i=e.getBoundingClientRect();a?i.left<=o/2&&i.right>=o/2?t=parseInt(e.getAttribute("data-chapter-index")):i.left>=0&&i.left<n&&(n=i.left,t===-1&&(t=parseInt(e.getAttribute("data-chapter-index")))):i.top<=s/3&&i.bottom>=s/3?t=parseInt(e.getAttribute("data-chapter-index")):i.top>=0&&i.top<n&&(n=i.top,t===-1&&(t=parseInt(e.getAttribute("data-chapter-index"))))}),t!==-1&&document.querySelectorAll(".tocBtn").forEach((e,n)=>{n===t?e.classList.add("active"):e.classList.remove("active")})};window.addEventListener("scroll",()=>{typeof a=="function"&&a(),_()},{passive:!0}),e.addEventListener("scroll",()=>{e.classList.contains("pagedMode")&&(typeof a=="function"&&a(),_())},{passive:!0});let G=[],X=0;const z=new URLSearchParams(window.location.search),L=z.get("novel")||"seirei-gensouki",$=z.get("vol")||"25",i=`/lector/data/${L}-${$}/`;let s=[],r=0,o=0,t=!1,B=null;const l=document.createElement("div"),d=document.createElement("div");l.style.height="1px",d.style.height="100px";const T=(e,t="")=>{let n=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(n+=`<source srcset="${i}${e}" type="image/avif">`),e.endsWith(".webp")&&(n+=`<source srcset="${i}${e}" type="image/webp">`)});const s=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];n+=`<img src="${i}${s}" alt="${t}">`}else n+=`<img src="${e}" alt="${t}">`;return n+=`</picture>`,n},j=async e=>{if(e<0||e>=s.length)return[];const t=s[e];let n=[];try{if(t.type==="cover"||t.type==="image"){let s=document.createElement("figure");return s.className="dimg grande readerChunk",s.setAttribute("data-chapter-index",e),s.innerHTML=T(t.images,t.title),n.push(s),n}if(t.type==="gallery")return t.images.forEach(s=>{let o=document.createElement("figure");o.className="dimg grande readerChunk",o.setAttribute("data-chapter-index",e),o.innerHTML=T(s,t.title),n.push(o)}),n;if(t.type==="html"){const a=await fetch(`${i}${t.file}`);if(!a.ok)throw new Error("Fragmento HTML fallido");const c=await a.text(),l=new DOMParser,r=l.parseFromString(c,"text/html"),d=r.querySelectorAll("img");d.forEach(e=>{let t=e.getAttribute("src");if(t&&t.includes("../Images/")){t=t.replace("../Images/","");let s=t.replace(".jpg","").replace(".jpeg","").replace(".png",""),n=document.createElement("picture");n.innerHTML=`<source srcset="${i}${s}.avif" type="image/avif"><img src="${i}${t}" alt="IlustraciÃ³n">`,e.parentNode.replaceChild(n,e)}});let s=r.body.children;s.length===1&&s[0].tagName==="SECTION"&&(s=s[0].children);let o=document.createElement("div");return o.className="readerChunk",o.setAttribute("data-chapter-index",e),Array.from(s).forEach(e=>{o.appendChild(e.cloneNode(!0))}),n.push(o),n}}catch(e){console.warn("Fallo cargando seccion:",e)}return n},E=async()=>{if(t||r<=0)return;t=!0,r--;const n=await j(r);if(n.length>0){const s=[];n.forEach(e=>{e.nodeType===1&&s.push(...Array.from(e.querySelectorAll("img")))}),s.length>0&&await Promise.all(s.map(e=>e.complete?Promise.resolve():new Promise(t=>{e.onload=t,e.onerror=t})));const o=e.classList.contains("pagedMode"),t=l.nextElementSibling;let i=t?t.getBoundingClientRect().top:0,a=t?t.getBoundingClientRect().left:0;if(n.reverse().forEach(e=>l.insertAdjacentElement("afterend",e)),t)if(o){const n=t.getBoundingClientRect().left-a;e.scrollBy({left:n,behavior:"instant"})}else{const e=t.getBoundingClientRect().top-i;window.scrollBy(0,e)}}p(),t=!1,setTimeout(a,150)},C=async()=>{if(t||o>=s.length-1)return;t=!0,o++;const e=await j(o);if(e.forEach(e=>d.insertAdjacentElement("beforebegin",e)),p(),o>=s.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",d.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}t=!1,setTimeout(a,150)},a=()=>{if(t)return;const n=e.classList.contains("pagedMode");if(n){const t=e.scrollLeft,n=e.scrollWidth,i=e.clientWidth;t<=300&&r>0?E():t+i>=n-300&&o<s.length-1&&C()}else{const e=l.getBoundingClientRect(),t=d.getBoundingClientRect(),n=window.innerHeight||document.documentElement.clientHeight;e.bottom>=-300&&r>0?E():t.top<=n+300&&o<s.length-1&&C()}},M=async n=>{t=!0,e.innerHTML="",r=n,o=n;const i=await j(n);if(e.appendChild(l),i.forEach(t=>e.appendChild(t)),o>=s.length-1){let t=document.createElement("p");t.className="centrado salto2",t.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",e.appendChild(t),document.querySelector(".readerLoadingSpinner")?.remove()}e.appendChild(d),t=!1,p(),window.scrollTo(0,0),setTimeout(()=>{a(),_()},200)},W=async()=>{try{const t=await fetch(`${i}index.json`);if(!t.ok)throw new Error("Index.json no encontrado");const e=await t.json();B=e,document.title=`${e.title} Vol ${e.volume} - Lector Web`,H.textContent=`${e.title} - Volumen ${e.volume}`,s=e.order;const n=document.getElementById("readerTocList");return n&&e.order.forEach((e,t)=>{let o=document.createElement("li"),s=document.createElement("button");s.className="tocBtn",s.textContent=e.title,s.onclick=()=>{M(t),b()},o.appendChild(s),n.appendChild(o)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};K(),h(),p(),W().then(e=>{if(e)M(0);else{const e=document.querySelector(".readerLoadingSpinner");e&&(e.textContent="Error: Faltan archivos de datos (index.json)")}})})