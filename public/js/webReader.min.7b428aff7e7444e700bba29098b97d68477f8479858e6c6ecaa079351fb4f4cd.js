document.addEventListener("DOMContentLoaded",()=>{const w=document.documentElement,B=document.getElementById("webReaderContainer"),O=document.getElementById("webReaderHeader"),x=document.getElementById("webReaderFooter"),k=document.getElementById("btnBack"),T=document.getElementById("btnSettings"),h=document.getElementById("webReaderSettings"),M=document.getElementById("settingsOverlay"),S=document.querySelectorAll(".themeBtn"),C=document.getElementById("fontSizeRange"),y=document.getElementById("lineHeightRange"),b=document.getElementById("fontFamilySelect"),v=document.getElementById("footnoteToast"),N=document.getElementById("footnoteToastContent"),P=document.getElementById("btnCloseToast"),p=document.getElementById("progressText");let m=!1;const R=()=>{const s=localStorage.getItem("kasniaReaderTheme")||"dark",e=localStorage.getItem("kasniaReaderFontSize")||"18",t=localStorage.getItem("kasniaReaderLineHeight")||"1.6",n=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif";w.setAttribute("data-theme",s),document.documentElement.style.setProperty("--reader-size",`${e}px`),document.documentElement.style.setProperty("--reader-line-height",t),document.documentElement.style.setProperty("--reader-font",n),C.value=e,y.value=t,b.value=n},d=(e,t)=>{localStorage.setItem(e,t)};S.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");w.setAttribute("data-theme",t),d("kasniaReaderTheme",t)})}),C.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),d("kasniaReaderFontSize",t)}),y.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),d("kasniaReaderLineHeight",t)}),b.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),d("kasniaReaderFont",t)});const j=()=>{m=!m,m?(O.classList.remove("hidden"),x.classList.remove("hidden")):(O.classList.add("hidden"),x.classList.add("hidden"),h.classList.add("hidden"))};B.addEventListener("click",e=>{if(e.target.closest("button")||e.target.closest("a")||e.target.closest(".webReaderHeader")||e.target.closest(".webReaderSettings")||e.target.closest(".footnoteToast"))return;j()}),T.addEventListener("click",()=>{h.classList.remove("hidden")}),M.addEventListener("click",()=>{h.classList.add("hidden")}),k.addEventListener("click",()=>{window.history.back()});const l=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(N.innerHTML=s.innerHTML,v.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};P.addEventListener("click",()=>{v.classList.add("hidden")});const _=()=>{const t=window.scrollY||document.documentElement.scrollTop,n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),s=document.documentElement.clientHeight,e=n-s;if(e>0){const n=Math.min(100,Math.max(0,Math.round(t/e*100)));p.textContent=`${n}%`}else p.textContent=`100%`};window.addEventListener("scroll",()=>{_(),typeof o=="function"&&o()},{passive:!0});const c=document.getElementById("webReaderContent"),A=document.getElementById("readerNovelTitle");let V=[],$=0;const E=new URLSearchParams(window.location.search),F=E.get("novel")||"seirei-gensouki",L=E.get("vol")||"25",t=`/lector/data/${F}-${L}/`;let s=[],r=0,n=0,e=!1,D=null;const a=document.createElement("div"),i=document.createElement("div");a.style.height="1px",i.style.height="100px";const f=(e,n="")=>{let s=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(s+=`<source srcset="${t}${e}" type="image/avif">`),e.endsWith(".webp")&&(s+=`<source srcset="${t}${e}" type="image/webp">`)});const o=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];s+=`<img src="${t}${o}" alt="${n}" loading="lazy">`}else s+=`<img src="${e}" alt="${n}" loading="lazy">`;return s+=`</picture>`,s},u=async e=>{if(e<0||e>=s.length)return[];const n=s[e];let o=[];try{if(n.type==="cover"||n.type==="image"){let e=document.createElement("figure");return e.className="dimg grande readerChunk",e.innerHTML=f(n.images,n.title),o.push(e),o}if(n.type==="gallery")return n.images.forEach(e=>{let t=document.createElement("figure");t.className="dimg grande readerChunk",t.innerHTML=f(e,n.title),o.push(t)}),o;if(n.type==="html"){const s=await fetch(`${t}${n.file}`);if(!s.ok)throw new Error("Fragmento HTML fallido");const a=await s.text(),r=new DOMParser,i=r.parseFromString(a,"text/html"),c=i.querySelectorAll("img");c.forEach(e=>{let n=e.getAttribute("src");if(n&&n.includes("../Images/")){n=n.replace("../Images/","");let o=n.replace(".jpg","").replace(".jpeg","").replace(".png",""),s=document.createElement("picture");s.innerHTML=`<source srcset="${t}${o}.avif" type="image/avif"><img src="${t}${n}" alt="IlustraciÃ³n" loading="lazy">`,e.parentNode.replaceChild(s,e)}});let e=i.body.children;return e.length===1&&e[0].tagName==="SECTION"&&(e=e[0].children),Array.from(e).forEach(e=>{let t=document.createElement("div");t.className="readerChunk",t.appendChild(e.cloneNode(!0)),o.push(t)}),o}}catch(e){console.warn("Fallo cargando seccion:",e)}return o},H=async()=>{if(e||r<=0)return;e=!0,r--;const t=await u(r);if(t.length>0){const e=a.nextElementSibling;let n=e?e.getBoundingClientRect().top:0;if(t.reverse().forEach(e=>a.insertAdjacentElement("afterend",e)),e){const t=e.getBoundingClientRect().top-n;window.scrollBy(0,t)}}l(),e=!1,setTimeout(o,150)},I=async()=>{if(e||n>=s.length-1)return;e=!0,n++;const t=await u(n);if(t.forEach(e=>i.insertAdjacentElement("beforebegin",e)),l(),n>=s.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",i.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}e=!1,setTimeout(o,150)},o=()=>{if(e)return;const t=a.getBoundingClientRect(),o=i.getBoundingClientRect(),c=window.innerHeight||document.documentElement.clientHeight;t.bottom>=-300&&r>0?H():o.top<=c+300&&n<s.length-1&&I()},g=async t=>{e=!0,c.innerHTML="",r=t,n=t;const s=await u(t);c.appendChild(a),s.forEach(e=>c.appendChild(e)),c.appendChild(i),e=!1,l(),window.scrollTo(0,0),setTimeout(o,200)},z=async()=>{try{const n=await fetch(`${t}index.json`);if(!n.ok)throw new Error("Index.json no encontrado");const e=await n.json();D=e,document.title=`${e.title} Vol ${e.volume} - Lector Web`,A.textContent=`${e.title} - Volumen ${e.volume}`,s=e.order;const o=document.getElementById("readerTocList");return o&&e.order.forEach((e,t)=>{let s=document.createElement("li"),n=document.createElement("button");n.className="tocBtn",n.textContent=e.title,n.onclick=()=>{g(t),j()},s.appendChild(n),o.appendChild(s)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};R(),l(),_(),z().then(e=>{if(e)g(0);else{const e=document.querySelector(".readerLoadingSpinner");e&&(e.textContent="Error: Faltan archivos de datos (index.json)")}})})