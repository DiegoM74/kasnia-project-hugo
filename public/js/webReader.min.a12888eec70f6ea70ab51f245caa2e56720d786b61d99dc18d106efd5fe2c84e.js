document.addEventListener("DOMContentLoaded",()=>{const C=document.documentElement,U=document.getElementById("webReaderContainer"),w=document.getElementById("webReaderHeader"),g=document.getElementById("webReaderFooter"),F=document.getElementById("btnBack"),R=document.getElementById("btnSettings"),r=document.getElementById("webReaderSettings"),L=document.getElementById("settingsOverlay"),N=document.querySelectorAll(".themeBtn"),A=document.getElementById("fontSizeRange"),S=document.getElementById("lineHeightRange"),E=document.getElementById("fontFamilySelect"),p=document.getElementById("footnoteToast"),I=document.getElementById("footnoteToastContent"),D=document.getElementById("btnCloseToast"),k=document.getElementById("btnToc"),d=document.getElementById("webReaderTocPanel"),v=document.getElementById("tocOverlay"),b=document.getElementById("hyphensToggle"),j=document.getElementById("btnCloseSettings"),y=document.getElementById("btnCloseToc");let f=!1;const V=()=>{const o=localStorage.getItem("kasniaReaderTheme")||"dark",e=localStorage.getItem("kasniaReaderFontSize")||"18",n=localStorage.getItem("kasniaReaderLineHeight")||"1.6",s=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif",i=localStorage.getItem("kasniaReaderHyphens")||"false";C.setAttribute("data-theme",o),document.documentElement.style.setProperty("--reader-size",`${e}px`),document.documentElement.style.setProperty("--reader-line-height",n),document.documentElement.style.setProperty("--reader-font",s),i==="true"&&(t.setAttribute("data-hyphens","true"),b.checked=!0),A.value=e,S.value=n,E.value=s},i=(e,t)=>{localStorage.setItem(e,t)};N.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");C.setAttribute("data-theme",t),i("kasniaReaderTheme",t)})}),A.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),i("kasniaReaderFontSize",t)}),S.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),i("kasniaReaderLineHeight",t)}),E.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),i("kasniaReaderFont",t)}),b.addEventListener("change",e=>{const n=e.target.checked;n?(t.setAttribute("data-hyphens","true"),i("kasniaReaderHyphens","true")):(t.removeAttribute("data-hyphens"),i("kasniaReaderHyphens","false"))});const x=()=>{f=!f,f?(w.classList.remove("hidden"),g.classList.remove("hidden")):(w.classList.add("hidden"),g.classList.add("hidden"),r.classList.add("hidden"),d.classList.add("hidden"))};U.addEventListener("click",e=>{if(e.target.closest("button")||e.target.closest("a")||e.target.closest(".webReaderHeader")||e.target.closest(".webReaderSettings")||e.target.closest(".footnoteToast"))return;x()}),R.addEventListener("click",()=>{r.classList.remove("hidden"),d.classList.add("hidden")}),L.addEventListener("click",()=>{r.classList.add("hidden")}),k&&k.addEventListener("click",()=>{d.classList.remove("hidden"),r.classList.add("hidden")}),v&&v.addEventListener("click",()=>{d.classList.add("hidden")}),j&&j.addEventListener("click",()=>{r.classList.add("hidden")}),y&&y.addEventListener("click",()=>{d.classList.add("hidden")}),F.addEventListener("click",()=>{window.history.back()});const h=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(I.innerHTML=s.innerHTML,p.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};D.addEventListener("click",()=>{p.classList.add("hidden")}),window.addEventListener("scroll",()=>{typeof u=="function"&&u()},{passive:!0});const t=document.getElementById("webReaderContent"),T=document.getElementById("readerNovelTitle");let K=[],q=0;const M=new URLSearchParams(window.location.search),B=M.get("novel")||"seirei-gensouki",H=M.get("vol")||"25",s=`/lector/data/${B}-${H}/`;let o=[],c=0,n=0,e=!1,P=null;const l=document.createElement("div"),a=document.createElement("div");l.style.height="1px",a.style.height="100px";const O=(e,t="")=>{let n=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(n+=`<source srcset="${s}${e}" type="image/avif">`),e.endsWith(".webp")&&(n+=`<source srcset="${s}${e}" type="image/webp">`)});const o=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];n+=`<img src="${s}${o}" alt="${t}">`}else n+=`<img src="${e}" alt="${t}">`;return n+=`</picture>`,n},m=async e=>{if(e<0||e>=o.length)return[];const t=o[e];let n=[];try{if(t.type==="cover"||t.type==="image"){let e=document.createElement("figure");return e.className="dimg grande readerChunk",e.innerHTML=O(t.images,t.title),n.push(e),n}if(t.type==="gallery")return t.images.forEach(e=>{let s=document.createElement("figure");s.className="dimg grande readerChunk",s.innerHTML=O(e,t.title),n.push(s)}),n;if(t.type==="html"){const i=await fetch(`${s}${t.file}`);if(!i.ok)throw new Error("Fragmento HTML fallido");const r=await i.text(),c=new DOMParser,a=c.parseFromString(r,"text/html"),l=a.querySelectorAll("img");l.forEach(e=>{let t=e.getAttribute("src");if(t&&t.includes("../Images/")){t=t.replace("../Images/","");let o=t.replace(".jpg","").replace(".jpeg","").replace(".png",""),n=document.createElement("picture");n.innerHTML=`<source srcset="${s}${o}.avif" type="image/avif"><img src="${s}${t}" alt="IlustraciÃ³n">`,e.parentNode.replaceChild(n,e)}});let e=a.body.children;e.length===1&&e[0].tagName==="SECTION"&&(e=e[0].children);let o=document.createElement("div");return o.className="readerChunk",Array.from(e).forEach(e=>{o.appendChild(e.cloneNode(!0))}),n.push(o),n}}catch(e){console.warn("Fallo cargando seccion:",e)}return n},$=async()=>{if(e||c<=0)return;e=!0,c--;const t=await m(c);if(t.length>0){const n=[];t.forEach(e=>{e.nodeType===1&&n.push(...Array.from(e.querySelectorAll("img")))}),n.length>0&&await Promise.all(n.map(e=>e.complete?Promise.resolve():new Promise(t=>{e.onload=t,e.onerror=t})));const e=l.nextElementSibling;let s=e?e.getBoundingClientRect().top:0;if(t.reverse().forEach(e=>l.insertAdjacentElement("afterend",e)),e){const t=e.getBoundingClientRect().top-s;window.scrollBy(0,t)}}h(),e=!1,setTimeout(u,150)},W=async()=>{if(e||n>=o.length-1)return;e=!0,n++;const t=await m(n);if(t.forEach(e=>a.insertAdjacentElement("beforebegin",e)),h(),n>=o.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",a.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}e=!1,setTimeout(u,150)},u=()=>{if(e)return;const t=l.getBoundingClientRect(),s=a.getBoundingClientRect(),i=window.innerHeight||document.documentElement.clientHeight;t.bottom>=-300&&c>0?$():s.top<=i+300&&n<o.length-1&&W()},_=async s=>{e=!0,t.innerHTML="",c=s,n=s;const i=await m(s);if(t.appendChild(l),i.forEach(e=>t.appendChild(e)),n>=o.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",t.appendChild(e),document.querySelector(".readerLoadingSpinner")?.remove()}t.appendChild(a),e=!1,h(),window.scrollTo(0,0),setTimeout(u,200)},z=async()=>{try{const t=await fetch(`${s}index.json`);if(!t.ok)throw new Error("Index.json no encontrado");const e=await t.json();P=e,document.title=`${e.title} Vol ${e.volume} - Lector Web`,T.textContent=`${e.title} - Volumen ${e.volume}`,o=e.order;const n=document.getElementById("readerTocList");return n&&e.order.forEach((e,t)=>{let o=document.createElement("li"),s=document.createElement("button");s.className="tocBtn",s.textContent=e.title,s.onclick=()=>{_(t),x()},o.appendChild(s),n.appendChild(o)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};V(),h(),z().then(e=>{if(e)_(0);else{const e=document.querySelector(".readerLoadingSpinner");e&&(e.textContent="Error: Faltan archivos de datos (index.json)")}})})