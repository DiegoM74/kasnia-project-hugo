document.addEventListener("DOMContentLoaded",()=>{const w=document.documentElement,L=document.getElementById("webReaderContainer"),f=document.getElementById("webReaderHeader"),v=document.getElementById("webReaderFooter"),M=document.getElementById("btnBack"),S=document.getElementById("btnSettings"),l=document.getElementById("webReaderSettings"),F=document.getElementById("settingsOverlay"),x=document.querySelectorAll(".themeBtn"),u=document.getElementById("fontSizeRange"),b=document.getElementById("lineHeightRange"),g=document.getElementById("fontFamilySelect"),h=document.getElementById("footnoteToast"),D=document.getElementById("footnoteToastContent"),T=document.getElementById("btnCloseToast"),p=document.getElementById("progressText");let r=!1;const C=()=>{const s=localStorage.getItem("kasniaReaderTheme")||"dark",e=localStorage.getItem("kasniaReaderFontSize")||"18",t=localStorage.getItem("kasniaReaderLineHeight")||"1.6",n=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif";w.setAttribute("data-theme",s),document.documentElement.style.setProperty("--reader-size",`${e}px`),document.documentElement.style.setProperty("--reader-line-height",t),document.documentElement.style.setProperty("--reader-font",n),u.value=e,b.value=t,g.value=n},a=(e,t)=>{localStorage.setItem(e,t)};x.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");w.setAttribute("data-theme",t),a("kasniaReaderTheme",t)})}),u.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),a("kasniaReaderFontSize",t)}),b.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),a("kasniaReaderLineHeight",t)}),g.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),a("kasniaReaderFont",t)});const j=()=>{r=!r,r?(f.classList.remove("hidden"),v.classList.remove("hidden")):(f.classList.add("hidden"),v.classList.add("hidden"),l.classList.add("hidden"))};L.addEventListener("click",e=>{if(e.target.closest("button")||e.target.closest("a")||e.target.closest(".webReaderHeader")||e.target.closest(".webReaderSettings")||e.target.closest(".footnoteToast"))return;j()}),S.addEventListener("click",()=>{l.classList.remove("hidden")}),F.addEventListener("click",()=>{l.classList.add("hidden")}),M.addEventListener("click",()=>{window.history.back()});const y=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(D.innerHTML=s.innerHTML,h.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};T.addEventListener("click",()=>{h.classList.add("hidden")});const _=()=>{const t=window.scrollY||document.documentElement.scrollTop,n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),s=document.documentElement.clientHeight,e=n-s;if(e>0){const n=Math.min(100,Math.max(0,Math.round(t/e*100)));p.textContent=`${n}%`}else p.textContent=`100%`};window.addEventListener("scroll",_,{passive:!0});const d=document.getElementById("webReaderContent"),E=document.getElementById("readerNovelTitle");let e=[],s=0;const O=new URLSearchParams(window.location.search),k=O.get("novel")||"seirei-gensouki",A=O.get("vol")||"25",t=`/lector/data/${k}-${A}/`;let c=[],i=0,n=null;const z=async()=>{try{const r=await fetch(`${t}index.json`);if(!r.ok)throw new Error("Index.json no encontrado");const a=await r.json();n=a,document.title=`${a.title} Vol ${a.volume} - Lector Web`,E.textContent=`${a.title} - Volumen ${a.volume}`,c=a.order;const l=document.getElementById("readerTocList");return l&&a.order.forEach((t,n)=>{let r=document.createElement("li"),a=document.createElement("button");a.className="tocBtn",a.textContent=t.title,a.onclick=()=>{d.innerHTML="",e=[],s=0,i=n,j(),o()},r.appendChild(a),l.appendChild(r)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}},m=(e,n="")=>{let s=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(s+=`<source srcset="${t}${e}" type="image/avif">`),e.endsWith(".webp")&&(s+=`<source srcset="${t}${e}" type="image/webp">`)});const o=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];s+=`<img src="${t}${o}" alt="${n}">`}else s+=`<img src="${e}" alt="${n}">`;return s+=`</picture>`,s},N=async s=>{try{let o=document.createElement("div");if(o.className="readerSectionTitle",s.id!=="cover"&&s.id!=="color_illus"&&s.id!=="title_page"){let t=document.createElement("h1");t.textContent=s.title,o.appendChild(t),e.push(o)}if(s.type==="cover"||s.type==="image"){let t=document.createElement("div");return t.className="readerChunk",t.innerHTML=`<figure class="dimg grande">${m(s.images,s.title)}</figure>`,e.push(t),!0}if(s.type==="gallery")return s.images.forEach(t=>{let n=document.createElement("div");n.className="readerChunk",n.innerHTML=`<figure class="dimg grande">${m(t,s.title)}</figure>`,e.push(n)}),!0;if(s.type==="synopsis"){let t=document.createElement("div");return t.className="readerChunk",t.innerHTML=`<h2 class="centrado" style="margin-bottom:2rem;">Sinopsis</h2><p>${n.synopsis}</p>`,e.push(t),!0}if(s.type==="title"){let t=document.createElement("div");return t.className="readerChunk",t.innerHTML=`<div class="centrado salto2"><h1 style="font-size:3rem; margin-bottom:0;">${n.title}</h1><h2 style="opacity:0.8; margin-top:0;">Volumen ${n.volume}</h2><p class="salto2">Autor: ${n.author}<br>Ilustrador: ${n.illustrator}</p></div>`,e.push(t),!0}if(s.type==="html"){const r=`${t}${s.file}`,i=await fetch(r);if(!i.ok)throw new Error("Fragmento no encontrado");const c=await i.text(),l=new DOMParser,o=l.parseFromString(c,"text/html"),d=o.querySelectorAll("img");d.forEach(e=>{let n=e.getAttribute("src");if(n&&n.includes("../Images/")){n=n.replace("../Images/","");let o=n.replace(".jpg","").replace(".jpeg","").replace(".png",""),s=document.createElement("picture");s.innerHTML=`<source srcset="${t}${o}.avif" type="image/avif"><img src="${t}${n}" alt="IlustraciÃ³n B/N">`,e.parentNode.replaceChild(s,e)}});const a=o.querySelector("h1");a&&a.remove();const u=o.body.querySelectorAll("h2, h3, h4, p, div:not(.readerChunk), figure, picture, ul, ol");let n=document.createElement("div");return n.className="readerChunk",Array.from(u).forEach(t=>{t.tagName==="FIGURE"||t.tagName==="PICTURE"?(n.children.length>0&&(e.push(n),n=document.createElement("div"),n.className="readerChunk"),n.appendChild(t.cloneNode(!0))):n.appendChild(t.cloneNode(!0))}),n.children.length>0&&e.push(n),!0}return!1}catch(e){return console.warn(`Error procesando ${s.title}:`,e),!1}},o=async()=>{if(e.length===0||s>=e.length){if(i>=c.length){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",d.appendChild(e),document.querySelector(".readerLoadingSpinner")?.remove();return}const t=c[i],n=await N(t);if(i++,!n||e.length===0)return o()}if(s<e.length){const t=e[s];d.appendChild(t),y(),R(t),s++}},R=e=>{const t=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(t.disconnect(),o())})},{rootMargin:"0px 0px 500px 0px"});e.lastElementChild?t.observe(e.lastElementChild):t.observe(e)};C(),y(),_(),z().then(e=>{e?o():document.querySelector(".readerLoadingSpinner").textContent="Error: Faltan archivos de datos (index.json)"})})