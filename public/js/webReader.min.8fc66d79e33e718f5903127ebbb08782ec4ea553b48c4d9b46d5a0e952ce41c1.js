document.addEventListener("DOMContentLoaded",()=>{const w=document.documentElement,L=document.getElementById("webReaderContainer"),f=document.getElementById("webReaderHeader"),v=document.getElementById("webReaderFooter"),M=document.getElementById("btnBack"),S=document.getElementById("btnSettings"),d=document.getElementById("webReaderSettings"),F=document.getElementById("settingsOverlay"),x=document.querySelectorAll(".themeBtn"),u=document.getElementById("fontSizeRange"),b=document.getElementById("lineHeightRange"),g=document.getElementById("fontFamilySelect"),h=document.getElementById("footnoteToast"),D=document.getElementById("footnoteToastContent"),T=document.getElementById("btnCloseToast"),p=document.getElementById("progressText");let c=!1;const C=()=>{const s=localStorage.getItem("kasniaReaderTheme")||"dark",e=localStorage.getItem("kasniaReaderFontSize")||"18",t=localStorage.getItem("kasniaReaderLineHeight")||"1.6",n=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif";w.setAttribute("data-theme",s),document.documentElement.style.setProperty("--reader-size",`${e}px`),document.documentElement.style.setProperty("--reader-line-height",t),document.documentElement.style.setProperty("--reader-font",n),u.value=e,b.value=t,g.value=n},r=(e,t)=>{localStorage.setItem(e,t)};x.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");w.setAttribute("data-theme",t),r("kasniaReaderTheme",t)})}),u.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),r("kasniaReaderFontSize",t)}),b.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),r("kasniaReaderLineHeight",t)}),g.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),r("kasniaReaderFont",t)});const j=()=>{c=!c,c?(f.classList.remove("hidden"),v.classList.remove("hidden")):(f.classList.add("hidden"),v.classList.add("hidden"),d.classList.add("hidden"))};L.addEventListener("click",e=>{if(e.target.closest("button")||e.target.closest("a")||e.target.closest(".webReaderHeader")||e.target.closest(".webReaderSettings")||e.target.closest(".footnoteToast"))return;j()}),S.addEventListener("click",()=>{d.classList.remove("hidden")}),F.addEventListener("click",()=>{d.classList.add("hidden")}),M.addEventListener("click",()=>{window.history.back()});const y=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(D.innerHTML=s.innerHTML,h.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};T.addEventListener("click",()=>{h.classList.add("hidden")});const _=()=>{const t=window.scrollY||document.documentElement.scrollTop,n=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),s=document.documentElement.clientHeight,e=n-s;if(e>0){const n=Math.min(100,Math.max(0,Math.round(t/e*100)));p.textContent=`${n}%`}else p.textContent=`100%`};window.addEventListener("scroll",_,{passive:!0});const i=document.getElementById("webReaderContent"),E=document.getElementById("readerNovelTitle");let e=[],s=0;const O=new URLSearchParams(window.location.search),k=O.get("novel")||"seirei-gensouki",A=O.get("vol")||"25",n=`/lector/data/${k}-${A}/`;let l=[],t=0,o=null;const z=async()=>{try{const c=await fetch(`${n}index.json`);if(!c.ok)throw new Error("Index.json no encontrado");const r=await c.json();o=r,document.title=`${r.title} Vol ${r.volume} - Lector Web`,E.textContent=`${r.title} - Volumen ${r.volume}`,l=r.order;const d=document.getElementById("readerTocList");return d&&r.order.forEach((n,o)=>{let c=document.createElement("li"),r=document.createElement("button");r.className="tocBtn",r.textContent=n.title,r.onclick=()=>{i.innerHTML="",e=[],s=0,t=o,j(),a()},c.appendChild(r),d.appendChild(c)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}},m=(e,t="")=>{let s=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(s+=`<source srcset="${n}${e}" type="image/avif">`),e.endsWith(".webp")&&(s+=`<source srcset="${n}${e}" type="image/webp">`)});const o=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];s+=`<img src="${n}${o}" alt="${t}">`}else s+=`<img src="${e}" alt="${t}">`;return s+=`</picture>`,s},N=async t=>{try{let s=document.createElement("div");if(s.className="readerSectionTitle",t.id!=="cover"&&t.id!=="color_illus"&&t.id!=="title_page"){let n=document.createElement("h1");n.textContent=t.title,s.appendChild(n),e.push(s)}if(t.type==="cover"||t.type==="image"){let n=document.createElement("div");return n.className="readerChunk",n.innerHTML=`<figure class="dimg grande">${m(t.images,t.title)}</figure>`,e.push(n),!0}if(t.type==="gallery")return t.images.forEach(n=>{let s=document.createElement("div");s.className="readerChunk",s.innerHTML=`<figure class="dimg grande">${m(n,t.title)}</figure>`,e.push(s)}),!0;if(t.type==="synopsis"){let t=document.createElement("div");return t.className="readerChunk",t.innerHTML=`<h2 class="centrado" style="margin-bottom:2rem;">Sinopsis</h2><p>${o.synopsis}</p>`,e.push(t),!0}if(t.type==="title"){let t=document.createElement("div");return t.className="readerChunk",t.innerHTML=`<div class="centrado salto2"><h1 style="font-size:3rem; margin-bottom:0;">${o.title}</h1><h2 style="opacity:0.8; margin-top:0;">Volumen ${o.volume}</h2><p class="salto2">Autor: ${o.author}<br>Ilustrador: ${o.illustrator}</p></div>`,e.push(t),!0}if(t.type==="html"){const r=`${n}${t.file}`,i=await fetch(r);if(!i.ok)throw new Error("Fragmento no encontrado");const c=await i.text(),l=new DOMParser,o=l.parseFromString(c,"text/html"),d=o.querySelectorAll("img");d.forEach(e=>{let t=e.getAttribute("src");if(t&&t.includes("../Images/")){t=t.replace("../Images/","");let o=t.replace(".jpg","").replace(".jpeg","").replace(".png",""),s=document.createElement("picture");s.innerHTML=`<source srcset="${n}${o}.avif" type="image/avif"><img src="${n}${t}" alt="Ilustración B/N">`,e.parentNode.replaceChild(s,e)}});const a=o.querySelector("h1");a&&a.remove();let s=document.createElement("div");s.className="readerChunk";const u=o.querySelector("section")||o.body;return Array.from(u.children).forEach(t=>{t.tagName==="FIGURE"||t.tagName==="PICTURE"?(s.children.length>0&&(e.push(s),s=document.createElement("div"),s.className="readerChunk"),s.appendChild(t.cloneNode(!0))):s.appendChild(t.cloneNode(!0))}),s.children.length>0&&e.push(s),!0}return!1}catch(e){return console.warn(`Error procesando ${t.title}:`,e),!1}},a=async()=>{if(e.length===0||s>=e.length){if(t>=l.length){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",i.appendChild(e),document.querySelector(".readerLoadingSpinner")?.remove();return}if(s===0&&(i.innerHTML="",t>0)){let n=document.createElement("button");n.className="readerBtn readerLoadPrevBtn",n.innerHTML="&#8593; Cargar sección anterior &#8593;",n.onclick=()=>{i.innerHTML="",e=[],s=0,t-=2,t<0&&(t=0),a()},i.appendChild(n)}const n=l[t],o=await N(n);if(t++,!o||e.length===0)return a()}if(s<e.length){const t=e[s];i.appendChild(t),y(),R(t),s++}},R=e=>{const t=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(t.disconnect(),a())})},{rootMargin:"0px 0px 500px 0px"});e.lastElementChild?t.observe(e.lastElementChild):t.observe(e)};C(),y(),_(),z().then(e=>{e?a():document.querySelector(".readerLoadingSpinner").textContent="Error: Faltan archivos de datos (index.json)"})})