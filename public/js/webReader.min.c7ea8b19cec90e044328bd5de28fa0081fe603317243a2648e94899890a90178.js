document.addEventListener("DOMContentLoaded",()=>{const S=document.documentElement,q=document.getElementById("webReaderContainer"),M=document.getElementById("webReaderHeader"),z=document.getElementById("webReaderFooter"),B=document.getElementById("btnBack"),H=document.getElementById("btnSettings"),l=document.getElementById("webReaderSettings"),P=document.getElementById("settingsOverlay"),e=document.getElementById("webReaderContent"),R=document.getElementById("readerNovelTitle"),V=document.querySelectorAll(".themeBtn"),E=document.getElementById("fontSizeRange"),j=document.getElementById("lineHeightRange"),A=document.getElementById("fontFamilySelect"),k=document.getElementById("footnoteToast"),U=document.getElementById("footnoteToastContent"),W=document.getElementById("btnCloseToast"),_=document.getElementById("btnToc"),u=document.getElementById("webReaderTocPanel"),D=document.getElementById("tocOverlay"),f=document.getElementById("hyphensToggle"),m=document.getElementById("pagedModeToggle"),w=document.getElementById("btnCloseSettings"),O=document.getElementById("btnCloseToc");let b=!1;const K=()=>{const o=localStorage.getItem("kasniaReaderTheme")||"dark",t=localStorage.getItem("kasniaReaderFontSize")||"18",n=localStorage.getItem("kasniaReaderLineHeight")||"1.6",s=localStorage.getItem("kasniaReaderFont")||"system-ui, sans-serif",i=localStorage.getItem("kasniaReaderHyphens")||"false",a=localStorage.getItem("kasniaReaderPagedMode")||"false";S.setAttribute("data-theme",o),document.documentElement.style.setProperty("--reader-size",`${t}px`),document.documentElement.style.setProperty("--reader-line-height",n),document.documentElement.style.setProperty("--reader-font",s),i==="true"&&(e.setAttribute("data-hyphens","true"),f&&(f.checked=!0)),a==="true"&&(document.body.classList.add("pagedMode"),e.classList.add("pagedMode"),m&&(m.checked=!0)),E.value=t,j.value=n,A.value=s},n=(e,t)=>{localStorage.setItem(e,t)};V.forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-theme");S.setAttribute("data-theme",t),n("kasniaReaderTheme",t)})}),E.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-size",`${t}px`),n("kasniaReaderFontSize",t)}),j.addEventListener("input",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-line-height",t),n("kasniaReaderLineHeight",t)}),A.addEventListener("change",e=>{const t=e.target.value;document.documentElement.style.setProperty("--reader-font",t),n("kasniaReaderFont",t)}),f.addEventListener("change",t=>{const s=t.target.checked;s?(e.setAttribute("data-hyphens","true"),n("kasniaReaderHyphens","true")):(e.removeAttribute("data-hyphens"),n("kasniaReaderHyphens","false"))}),m&&m.addEventListener("change",t=>{const s=t.target.checked;s?(document.body.classList.add("pagedMode"),e.classList.add("pagedMode"),n("kasniaReaderPagedMode","true")):(document.body.classList.remove("pagedMode"),e.classList.remove("pagedMode"),n("kasniaReaderPagedMode","false"))});const g=()=>{b=!b,b?(M.classList.remove("hidden"),z.classList.remove("hidden")):(M.classList.add("hidden"),z.classList.add("hidden"),l.classList.add("hidden"),u.classList.add("hidden"))};q.addEventListener("click",t=>{if(t.target.closest("button")||t.target.closest("a")||t.target.closest(".webReaderHeader")||t.target.closest(".webReaderSettings")||t.target.closest(".footnoteToast"))return;if(e.classList.contains("pagedMode")){const s=t.clientX,n=window.innerWidth;s<n*.25?e.scrollBy({left:-n,behavior:"smooth"}):s>n*.75?e.scrollBy({left:n,behavior:"smooth"}):g()}else g()}),H.addEventListener("click",()=>{l.classList.remove("hidden"),u.classList.add("hidden")}),P.addEventListener("click",()=>{l.classList.add("hidden")}),_&&_.addEventListener("click",()=>{u.classList.remove("hidden"),l.classList.add("hidden")}),D&&D.addEventListener("click",()=>{u.classList.add("hidden")}),w&&w.addEventListener("click",()=>{l.classList.add("hidden")}),O&&O.addEventListener("click",()=>{u.classList.add("hidden")}),B.addEventListener("click",()=>{window.history.back()});const h=()=>{const e=document.querySelectorAll('.webReaderContent a[href^="#"]');e.forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("href");if(n.startsWith("#")){t.preventDefault();const e=n.substring(1),s=document.getElementById(e);s?(U.innerHTML=s.innerHTML,k.classList.remove("hidden")):console.warn("Footnote reference not found in current DOM: ",e)}})})};W.addEventListener("click",()=>{k.classList.add("hidden")});const p=()=>{const i=document.querySelectorAll(".readerChunk[data-chapter-index]"),a=e.classList.contains("pagedMode");let t=-1,n=1/0;const s=window.innerHeight||document.documentElement.clientHeight,o=window.innerWidth||document.documentElement.clientWidth;i.forEach(e=>{const i=e.getBoundingClientRect();a?i.left<=o/2&&i.right>=o/2?t=parseInt(e.getAttribute("data-chapter-index")):i.left>=0&&i.left<n&&(n=i.left,t===-1&&(t=parseInt(e.getAttribute("data-chapter-index")))):i.top<=s/3&&i.bottom>=s/3?t=parseInt(e.getAttribute("data-chapter-index")):i.top>=0&&i.top<n&&(n=i.top,t===-1&&(t=parseInt(e.getAttribute("data-chapter-index"))))}),t!==-1&&document.querySelectorAll(".tocBtn").forEach((e,n)=>{n===t?e.classList.add("active"):e.classList.remove("active")})};window.addEventListener("scroll",()=>{typeof i=="function"&&i(),p()},{passive:!0}),e.addEventListener("scroll",()=>{e.classList.contains("pagedMode")&&(typeof i=="function"&&i(),p())},{passive:!0});let Y=[],G=0;const T=new URLSearchParams(window.location.search),L=T.get("novel")||"seirei-gensouki",N=T.get("vol")||"25",a=`/lector/data/${L}-${N}/`;let s=[],r=0,o=0,t=!1,I=null;const c=document.createElement("div"),d=document.createElement("div");c.style.height="1px",d.style.height="100px";const F=(e,t="")=>{let n=`<picture>`;if(Array.isArray(e)){e.forEach(e=>{e.endsWith(".avif")&&(n+=`<source srcset="${a}${e}" type="image/avif">`),e.endsWith(".webp")&&(n+=`<source srcset="${a}${e}" type="image/webp">`)});const s=e.find(e=>e.endsWith(".jpg")||e.endsWith(".png"))||e[0];n+=`<img src="${a}${s}" alt="${t}">`}else n+=`<img src="${e}" alt="${t}">`;return n+=`</picture>`,n},v=async e=>{if(e<0||e>=s.length)return[];const t=s[e];let n=[];try{if(t.type==="cover"||t.type==="image"){let s=document.createElement("figure");return s.className="dimg grande readerChunk",s.setAttribute("data-chapter-index",e),s.innerHTML=F(t.images,t.title),n.push(s),n}if(t.type==="gallery")return t.images.forEach(s=>{let o=document.createElement("figure");o.className="dimg grande readerChunk",o.setAttribute("data-chapter-index",e),o.innerHTML=F(s,t.title),n.push(o)}),n;if(t.type==="html"){const i=await fetch(`${a}${t.file}`);if(!i.ok)throw new Error("Fragmento HTML fallido");const c=await i.text(),l=new DOMParser,r=l.parseFromString(c,"text/html"),d=r.querySelectorAll("img");d.forEach(e=>{let t=e.getAttribute("src");if(t&&t.includes("../Images/")){t=t.replace("../Images/","");let s=t.replace(".jpg","").replace(".jpeg","").replace(".png",""),n=document.createElement("picture");n.innerHTML=`<source srcset="${a}${s}.avif" type="image/avif"><img src="${a}${t}" alt="IlustraciÃ³n">`,e.parentNode.replaceChild(n,e)}});let s=r.body.children;s.length===1&&s[0].tagName==="SECTION"&&(s=s[0].children);let o=document.createElement("div");return o.className="readerChunk",o.setAttribute("data-chapter-index",e),Array.from(s).forEach(e=>{o.appendChild(e.cloneNode(!0))}),n.push(o),n}}catch(e){console.warn("Fallo cargando seccion:",e)}return n},y=async()=>{if(t||r<=0)return;t=!0,r--;const n=await v(r);if(n.length>0){const s=[];n.forEach(e=>{e.nodeType===1&&s.push(...Array.from(e.querySelectorAll("img")))}),s.length>0&&await Promise.all(s.map(e=>e.complete?Promise.resolve():new Promise(t=>{e.onload=t,e.onerror=t})));const o=e.classList.contains("pagedMode"),t=c.nextElementSibling;let i=t?t.getBoundingClientRect().top:0,a=t?t.getBoundingClientRect().left:0;if(n.reverse().forEach(e=>c.insertAdjacentElement("afterend",e)),t)if(o){const n=t.getBoundingClientRect().left-a;e.scrollBy({left:n,behavior:"instant"})}else{const e=t.getBoundingClientRect().top-i;window.scrollBy(0,e)}}h(),t=!1,setTimeout(i,150)},C=async()=>{if(t||o>=s.length-1)return;t=!0,o++;const e=await v(o);if(e.forEach(e=>d.insertAdjacentElement("beforebegin",e)),h(),o>=s.length-1){let e=document.createElement("p");e.className="centrado salto2",e.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",d.insertAdjacentElement("beforebegin",e),document.querySelector(".readerLoadingSpinner")?.remove()}t=!1,setTimeout(i,150)},i=()=>{if(t)return;const n=e.classList.contains("pagedMode");if(n){const t=e.scrollLeft,n=e.scrollWidth,i=e.clientWidth;t<=300&&r>0?y():t+i>=n-300&&o<s.length-1&&C()}else{const e=c.getBoundingClientRect(),t=d.getBoundingClientRect(),n=window.innerHeight||document.documentElement.clientHeight;e.bottom>=-300&&r>0?y():t.top<=n+300&&o<s.length-1&&C()}},x=async n=>{t=!0,e.innerHTML="",r=n,o=n;const a=await v(n);if(e.appendChild(c),a.forEach(t=>e.appendChild(t)),o>=s.length-1){let t=document.createElement("p");t.className="centrado salto2",t.innerHTML="<b>Fin del volumen.</b><br>Gracias por leer Kasnia Project.",e.appendChild(t),document.querySelector(".readerLoadingSpinner")?.remove()}e.appendChild(d),t=!1,h(),window.scrollTo(0,0),setTimeout(()=>{i(),p()},200)},$=async()=>{try{const t=await fetch(`${a}index.json`);if(!t.ok)throw new Error("Index.json no encontrado");const e=await t.json();I=e,document.title=`${e.title} Vol ${e.volume} - Lector Web`,R.textContent=`${e.title} - Volumen ${e.volume}`,s=e.order;const n=document.getElementById("readerTocList");return n&&e.order.forEach((e,t)=>{let o=document.createElement("li"),s=document.createElement("button");s.className="tocBtn",s.textContent=e.title,s.onclick=()=>{x(t),g()},o.appendChild(s),n.appendChild(o)}),!0}catch(e){return console.warn("Fallo el index.json. ",e),!1}};K(),h(),$().then(e=>{if(e)x(0);else{const e=document.querySelector(".readerLoadingSpinner");e&&(e.textContent="Error: Faltan archivos de datos (index.json)")}})})