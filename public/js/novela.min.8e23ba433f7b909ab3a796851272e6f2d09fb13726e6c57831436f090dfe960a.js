document.addEventListener("DOMContentLoaded",()=>{initSynopsisToggle(),initModal()});function initSynopsisToggle(){const e=document.querySelector(".synopsisContent"),t=document.querySelector(".synopsisToggle");if(!e||!t)return;const n=()=>{e.classList.add("collapsed");const n=e.scrollHeight>e.clientHeight;t.classList.toggle("visible",n),n||e.classList.remove("collapsed")};n(),window.addEventListener("resize",n,{passive:!0}),t.addEventListener("click",()=>{const n=t.classList.contains("expanded");e.classList.toggle("collapsed",n),t.classList.toggle("expanded",!n),t.innerHTML=`
      ${n?"Ver m√°s":"Ver menos"}
      <svg><use href="/img/svg/novela.svg#chevronDown" /></svg>
    `})}function initModal(){const e=document.getElementById("downloadModal");if(!e)return;const g=e.querySelector(".modalClose"),c=document.getElementById("modalVolumeTitle"),m=e.querySelector(".modalHeader"),h=document.getElementById("creditsContainer"),n=document.getElementById("webReaderLink"),u=document.getElementById("pdfDownloadLink"),d=document.getElementById("epubDownloadLink"),s=e.querySelectorAll(".serverBtn"),a=e=>e&&e!=="#"&&e.trim()!=="",i=e=>a(e?.pdf)||a(e?.epub);let t={};function r(e,t){e.href=t||"#",e.classList.toggle("disabled",!a(t))}function l(e){const n=t[e]||{};r(u,n.pdf),r(d,n.epub)}function f(){s.forEach(e=>{const n=t[e.dataset.server];e.classList.toggle("disabled",!i(n))})}function p(o){const r=o.dataset.volume,d=JSON.parse(o.dataset.credits||"[]");t=JSON.parse(o.dataset.links||"{}");const u=o.classList.contains("preview"),p=o.dataset.webReader==="true",g=o.dataset.novelLink||"#";n&&(p?(n.style.display="flex",n.href=g):(n.style.display="none",n.href="#")),m.querySelector(".previewIndicator")?.remove(),c.textContent=`Volumen ${r}`,u&&c.insertAdjacentHTML("afterend",`
        <span class="previewIndicator">
          <svg><use href="/img/svg/novela.svg#eyeIcon" /></svg>
          Vista previa
        </span>
      `),h.innerHTML=d.map(e=>`
        <div class="creditItem">
          <span class="creditRole">${e.role}</span>
          <span class="creditName">${e.name}</span>
        </div>
      `).join(""),f();const v=i(t.propio),b=i(t.drive),a=v?"propio":b?"drive":"propio";s.forEach(e=>{e.classList.toggle("active",e.dataset.server===a)}),l(a),e.classList.add("active")}function o(){e.classList.remove("active")}function v(t){l(t),e.querySelectorAll(".downloadLink:not(.disabled)").forEach(e=>{e.classList.remove("update-flash"),void e.offsetWidth,e.classList.add("update-flash")})}document.querySelector(".volumesGrid")?.addEventListener("click",e=>{const t=e.target.closest(".volumeCard");t&&!t.classList.contains("upcoming")&&p(t)}),g?.addEventListener("click",o),e.addEventListener("click",t=>{t.target===e&&o()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&e.classList.contains("active")&&o()}),e.querySelector(".serverToggle")?.addEventListener("click",e=>{const t=e.target.closest(".serverBtn");if(!t||t.classList.contains("disabled")||t.classList.contains("active"))return;s.forEach(e=>e.classList.remove("active")),t.classList.add("active"),v(t.dataset.server)})}